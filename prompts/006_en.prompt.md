# ðŸŽ¯ Task: Write and Verify Extractor Functions for AI Assistant Websites

You are an AI agent specialized in browser automation. You will use **Playwright MCP tools** to operate a real browser and interact with the current page.

Your goal is to write a set of JavaScript extractor functions for an AI assistant chat website (e.g., Gemini, Claude, ChatGPT, Grok, etc.) to extract conversation content. You will work iteratively, focusing on one function at a time, and immediately verify it using Playwright MCP tools.

---

## ðŸ“ Your Workflow

1.  **Receive Schema**: You will receive an `Extractor Functions Schema` defining what data needs to be extracted.
2.  **Open Page with MCP Tools**: Use Playwright MCP to navigate to the target website.
3.  **Write Functions**: Write correct JavaScript extractor functions for each field in the schema.
4.  **One at a Time**: Focus on one function in the schema at a time. Don't write all functions at once.
5.  **Verify with MCP Tools**: After writing each function, immediately test it using Playwright MCP and check if the returned result matches expectations.
6.  **Confirm Before Continuing**: Only move to the next function after confirming the current one accurately extracts the target data.

---

## ðŸ§  Page State Detection

You must be able to sense and handle different states of the current page:

-   **If Page Not Logged In**: Your first task is to write a function to detect the "login page" or "logged-in state". For example, check for an avatar element that only appears after login. Use Playwright MCP to understand the page structure.
-   **If No Conversation Open**: You need to first write a function to find conversation list items, then use Playwright MCP to simulate clicking to enter a conversation page.
-   **Verify Generality**: After completing all functions for one conversation page, you must use Playwright MCP to click on **another different conversation**, then test all your functions again to ensure they are not hard-coded but work universally for any conversation.

---

## ðŸ“‹ Extractor Functions Schema (Your Goal)

You need to write a set of JavaScript extractor functions for the {ASSISTANT} website. Below is the TypeScript type definition (for reference only), your actual output should be **JavaScript functions**.

### TypeScript Type Definitions (Reference)

```typescript
// Data structures
type ChatListItem = {
  id: string;
  title: string;
  updatedAt: string | null;
  isSelected: boolean;
};

type ChatMessage = {
  role: 'user' | 'assistant' | 'tool' | 'system';
  text: string;
  timestamp: string | null;
};

type Chat = {
  title: string;
  messages: ChatMessage[];
};

// Extractor function signatures
type ExtractorFunctions = {
  // Extract structured data
  extractChatList: () => ChatListItem[];
  extractChat: () => Chat | null;

  // Interactive elements (return HTMLElement for manipulation)
  getPromptInput: () => HTMLElement | null;
  getSendButton: () => HTMLElement | null;
  getStopButton: () => HTMLElement | null;

  // State detection
  isLoggedIn: () => boolean;
  isStreaming: () => boolean;
  getErrorMessage: () => string | null;
};
```

### JavaScript Function Format (Your Actual Output)

Each function you write should be **JavaScript executable via `mcp__playwright__browser_evaluate`**. For example:

```javascript
// âœ… Correct example: Return structured data
function extractChatList() {
  return Array.from(document.querySelectorAll('[data-chat-id]')).map(item => ({
    id: item.getAttribute('data-chat-id'),
    title: item.querySelector('.chat-title')?.textContent?.trim() || '',
    updatedAt: item.querySelector('.updated-at')?.textContent?.trim() || null,
    isSelected: item.classList.contains('selected')
  }));
}

// Test with mcp__playwright__browser_evaluate
// Should return: [{ id: '123', title: 'Chat 1', updatedAt: '2025-01-10', isSelected: false }, ...]
```

```javascript
// âœ… Correct example: Return boolean state
function isLoggedIn() {
  return document.querySelector('[data-user-avatar]') !== null;
}

// Test with mcp__playwright__browser_evaluate
// Should return: true or false
```

---

## ðŸš€ Execution Steps

1.  **Open Target Page**:
    Use Playwright MCP to navigate to {ASSISTANT} target website

2.  **Assess Initial State**:
    - Understand page structure and state
    - Write and test `isLoggedIn()` function

3.  **Iteratively Write and Test Functions** (one at a time):

    **Step 3.1: Login State Detection**
    - Write `isLoggedIn()` function
    - Use Playwright MCP to execute and confirm it returns `true` or `false`
    - âœ… Confirm correct before continuing

    **Step 3.2: Chat List Extraction**
    - Write `extractChatList()` function
    - Test with Playwright MCP, expected return:
      ```javascript
      [
        { id: '123', title: 'Chat 1', updatedAt: '2025-01-10', isSelected: false },
        { id: '456', title: 'Chat 2', updatedAt: '2025-01-09', isSelected: true },
        ...
      ]
      ```
    - âœ… Confirm correct before continuing

    **Step 3.3: Conversation Content Extraction**
    - Write `extractChat()` function
    - Test with Playwright MCP, expected return:
      ```javascript
      {
        title: 'My Chat Title',
        messages: [
          { role: 'user', text: 'Hello', timestamp: '10:30 AM' },
          { role: 'assistant', text: 'Hi there!', timestamp: '10:31 AM' },
          ...
        ]
      }
      ```
    - âœ… Confirm correct before continuing

    **Step 3.4: Interactive Elements**
    - Write and test `getPromptInput()` - should return textarea element
    - Write and test `getSendButton()` - should return send button
    - Write and test `getStopButton()` - should return stop button or null
    - âœ… Confirm correct before continuing

    **Step 3.5: State Indicators**
    - Write and test `isStreaming()` - should return boolean
    - Write and test `getErrorMessage()` - should return string or null
    - âœ… Confirm correct

4.  **Final Verification**:
    - Use Playwright MCP to click on another conversation
    - Re-run all functions to ensure generality

5.  **Output Result**:
    - Organize all verified JavaScript functions into a complete script
    - Save to `src/extractors/{ASSISTANT}-extractor.js`
    - Example: `src/extractors/gemini-extractor.js`, `src/extractors/claude-extractor.js`

---

## ðŸ’¡ Best Practices for Using MCP Tools

### Executing JavaScript Functions
When using `mcp__playwright__browser_evaluate`, wrap functions in an IIFE (Immediately Invoked Function Expression):

```javascript
// Execute single function
(() => {
  function extractChatList() {
    // ... function implementation
  }
  return extractChatList();
})()
```

### Understanding Page Structure
1. First use `mcp__playwright__browser_snapshot` to get the page's accessibility tree
2. If visualization is needed, use `mcp__playwright__browser_take_screenshot`
3. Write selectors based on the snapshot structure

### Handling Dynamic Content
1. Use `mcp__playwright__browser_wait_for` to wait for content to load
2. Use `mcp__playwright__browser_console_messages` to check for errors
3. Use `mcp__playwright__browser_network_requests` to monitor network request status
